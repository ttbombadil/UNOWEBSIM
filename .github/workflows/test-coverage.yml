name: Test & Coverage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    name: Run tests and collect coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage

      - name: Upload HTML coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage/lcov-report
          retention-days: 7

      # ensure coverage JSON is available in the publish dir
      - name: Copy coverage JSON into publish dir
        if: always()
        run: |
          mkdir -p coverage/lcov-report
          cp coverage/coverage-final.json coverage/lcov-report/ || true

      - name: Generate coverage summary JSON
        if: always()
        run: |
          node -e "const fs=require('fs');const path='coverage/coverage-final.json';if(!fs.existsSync(path)){console.error('coverage-final.json not found');process.exit(0);}const cov=JSON.parse(fs.readFileSync(path,'utf8'));let sCovered=0,sTotal=0,fCovered=0,fTotal=0,bCovered=0,bTotal=0;for(const k of Object.keys(cov)){const file=cov[k];const s=file.s||{};sTotal+=Object.keys(s).length;sCovered+=Object.values(s).filter(v=>v>0).length;const f=file.f||{};fTotal+=Object.keys(f).length;fCovered+=Object.values(f).filter(v=>v>0).length;const b=file.b||{};for(const bid of Object.keys(b)){const arr=b[bid]||[];bTotal+=Array.isArray(arr)?arr.length:0;bCovered+=Array.isArray(arr)?arr.filter(v=>v>0).length:0;}}const pct=(cov,total)=>{};const summary={statements:{covered:sCovered,total:sTotal,percent: sTotal? Number((sCovered/sTotal*100).toFixed(2)):0},functions:{covered:fCovered,total:fTotal,percent: fTotal? Number((fCovered/fTotal*100).toFixed(2)):0},branches:{covered:bCovered,total:bTotal,percent: bTotal? Number((bCovered/bTotal*100).toFixed(2)):0},generatedAt:(new Date()).toISOString()};fs.writeFileSync('coverage/lcov-report/coverage-summary.json',JSON.stringify(summary,null,2));console.log('wrote coverage/lcov-report/coverage-summary.json');"

      - name: Deploy coverage to GitHub Pages (gh-pages branch)
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          # Prefer a user PAT stored in `GH_PAGES_TOKEN` for push permission
          # Fallback to the workflow GITHUB_TOKEN when PAT is not provided
          github_token: ${{ secrets.GH_PAGES_TOKEN || secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage/lcov-report
          publish_branch: gh-pages
          allow_empty_commit: true
